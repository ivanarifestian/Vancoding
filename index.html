<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Absensi Siswa - VAN KARTU</title>
  <style>
    :root{--bg:#f6fbfb;--blue-tosca:#0fb2a6;--card:#fff;--muted:#666}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:18px}
    .center{max-width:1100px;margin:18px auto}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:72px;height:72px;background:#ddd;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(10,10,10,0.06);}
    .login-wrap{display:flex;gap:20px;align-items:center}
    .login-form{width:360px;padding:20px;border-radius:12px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type=text],input[type=password],select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{background:var(--blue-tosca);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .flex{display:flex;gap:12px;align-items:center}
    .space-between{display:flex;justify-content:space-between;align-items:center}
    .small{font-size:13px}
    .students-list{max-height:260px;overflow:auto;margin-top:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .btn-ghost{background:transparent;border:1px solid #ddd;padding:8px;border-radius:8px}
    .qr-canvas{width:320px;height:240px;background:#000;border-radius:8px}
    .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .notice{background:#e9fffb;border:1px solid #c7fff4;padding:10px;border-radius:8px;color:#046654}
  </style>
  <!-- Libraries: QR code reader, QR generator, jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="center">
    <header class="card">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo" id="logoPreview"><img id="logoImg" src="" alt="logo" style="width:100%;height:100%;object-fit:contain;display:none"/></div>
        <div>
          <h2 id="schoolName">Nama Sekolah</h2>
          <div class="muted" id="schoolMeta">Guru: - | Kepala Sekolah: -</div>
        </div>
      </div>
    </header>

    <!-- Login Page -->
    <section id="loginPage" class="card" style="margin-top:14px">
      <div class="login-wrap">
        <div style="flex:1">
          <h3>Login Admin</h3>
          <p class="muted">Masuk sebagai admin untuk mengelola absensi.</p>
          <form id="loginForm" class="login-form">
            <label>Username</label>
            <input type="text" id="username" placeholder="Username" value="">
            <label>Password</label>
            <input type="password" id="password" placeholder="Password" value="">
            <div style="margin-top:12px" class="flex">
              <button type="submit">Masuk</button>
              <button type="button" class="btn-ghost" id="openStudentView">Tampilan Siswa</button>
            </div>
            <p class="muted small" style="margin-top:8px">Username: <strong>Van64</strong> â€¢ Password: <strong>Van1909</strong></p>
          </form>
        </div>
        <div style="width:540px">
          <h4>Ringkasan</h4>
          <div class="notice">Aplikasi ini menyimpan data di browser (localStorage). Untuk penggunaan multi-device dan produksi butuh backend.</div>
          <ul>
            <li>Tambahkan siswa manual atau unggah file CSV (kolom: id,nama)</li>
            <li>Admin dapat membuat sesi absensi dan men-generate QR session</li>
            <li>Atau generate QR per siswa untuk scan otomatis berisi ID</li>
            <li>Ekspor hasil ke Excel (.csv) dan PDF</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="adminPage" style="display:none;margin-top:14px">
      <div class="topbar">
        <h3>Dashboard Admin</h3>
        <div>
          <button id="btnLogout" class="btn-ghost">Logout</button>
        </div>
      </div>

      <div class="card">
        <div class="space-between">
          <div>
            <h4>Manajemen Siswa</h4>
            <div class="muted small">Tambah, import CSV, dan lihat daftar siswa.</div>
          </div>
          <div>
            <input type="file" id="csvFile" accept=".csv">
            <button id="btnExportAll" class="btn-ghost">Export Semua Siswa</button>
          </div>
        </div>

        <div style="margin-top:10px" class="flex">
          <div style="flex:1;margin-right:12px">
            <label>Tambah Siswa (manual)</label>
            <input type="text" id="newId" placeholder="ID siswa (unik)">
            <input type="text" id="newName" placeholder="Nama siswa" style="margin-top:6px">
            <div style="margin-top:8px" class="flex">
              <button id="addStudent">Tambah</button>
              <button id="generateQRAll" class="btn-ghost">Buat QR Per Siswa (lihat bawah)</button>
            </div>
            <div class="students-list card" id="studentsContainer" style="margin-top:10px"></div>
          </div>
          <div style="width:320px">
            <label>Opsi Cepat</label>
            <div style="margin-top:6px">
              <button id="startSession">Mulai Sesi Absensi</button>
              <button id="endSession" class="btn-ghost">Akhiri Sesi</button>
            </div>

            <div style="margin-top:12px">
              <label>QR Session (tunjukkan agar siswa scan)</label>
              <div id="qrcodeSession" style="padding:8px;background:#fff;border-radius:8px;margin-top:6px"></div>
              <div class="muted small" id="sessionInfo"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- QR per siswa -->
      <div style="margin-top:12px" class="card">
        <h4>QR Per Siswa</h4>
        <div class="muted small">Buat QR berisi student id yang dapat diprint atau ditampilkan pada layar siswa.</div>
        <div id="qrPerStudents" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px"></div>
      </div>

      <!-- Absensi -->
      <div style="margin-top:12px" class="card">
        <div class="space-between">
          <h4>Absensi Hari Ini</h4>
          <div>
            <button id="exportCSV" class="btn-ghost">Download CSV (Excel)</button>
            <button id="exportPDF" class="btn-ghost">Download PDF</button>
            <button id="clearAttendance" class="btn-ghost">Bersihkan Hari</button>
          </div>
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>ID</th><th>Nama</th><th>Status</th><th>Waktu</th></tr></thead>
            <tbody id="attendanceTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings -->
      <div style="margin-top:12px" class="card">
        <h4>Setelan</h4>
        <div class="settings-grid">
          <div>
            <label>Upload Logo Sekolah</label>
            <input type="file" id="logoUpload" accept="image/*">
          </div>
          <div>
            <label>Nama Sekolah</label>
            <input type="text" id="inputSchoolName" placeholder="Contoh: SD Negeri 1" />
          </div>
          <div>
            <label>Nama Guru</label>
            <input type="text" id="inputGuru" placeholder="Nama Guru" />
          </div>
          <div>
            <label>Nama Kepala Sekolah</label>
            <input type="text" id="inputKepala" placeholder="Nama Kepala Sekolah" />
          </div>
        </div>
        <div style="margin-top:8px" class="flex">
          <button id="saveSettings">Simpan Setelan</button>
          <button id="resetAll" class="btn-ghost">Reset Semua (hapus localStorage)</button>
        </div>
      </div>
    </section>

    <!-- Student View (untuk dipakai siswa) -->
    <section id="studentPage" class="card" style="display:none;margin-top:14px">
      <div class="topbar"><h3>Tampilan Siswa - Scan QR untuk Absensi</h3><div><button id="backToLogin" class="btn-ghost">Kembali</button></div></div>
      <div class="flex">
        <div style="flex:1">
          <label>Pilih Nama Anda (atau scan QR yang berisi id Anda otomatis)</label>
          <select id="studentSelect"></select>
          <div style="margin-top:8px">
            <button id="scanBtn">Mulai Scan Kamera</button>
            <button id="stopScan" class="btn-ghost">Stop</button>
          </div>
          <div style="margin-top:8px" class="muted small">Setelah scan QR, absensi akan tersimpan otomatis jika QR valid.</div>
          <div style="margin-top:8px">
            <label>Riwayat Absensi</label>
            <div id="studentHistory" class="card" style="max-height:200px;overflow:auto;margin-top:6px"></div>
          </div>
        </div>
        <div style="width:360px">
          <label>Kamera (preview)</label>
          <video id="video" autoplay muted playsinline class="qr-canvas"></video>
          <canvas id="canvas" style="display:none"></canvas>
        </div>
      </div>
    </section>

  </div>

<script>
// Simple localStorage-backed app
const ADMIN_USER='Van64', ADMIN_PASS='Van1909';
// utility
const qs = s => document.querySelector(s);
const qsa = s => document.querySelectorAll(s);

// Load initial settings
function loadSettings(){
  const s=JSON.parse(localStorage.getItem('van_settings')||'{}');
  if(s.name) qs('#schoolName').textContent = s.name;
  qs('#inputSchoolName').value = s.name||'';
  qs('#inputGuru').value = s.guru||'';
  qs('#inputKepala').value = s.kepala||'';
  if(s.logo){
    const img = qs('#logoImg'); img.src = s.logo; img.style.display='block';
  }
}

function saveSettings(){
  const s={name:qs('#inputSchoolName').value,guru:qs('#inputGuru').value,kepala:qs('#inputKepala').value,logo:qs('#logoImg').src||''}
  localStorage.setItem('van_settings',JSON.stringify(s));
  loadSettings();
  alert('Setelan disimpan.');
}

// Students
function getStudents(){return JSON.parse(localStorage.getItem('van_students')||'[]')}
function setStudents(arr){localStorage.setItem('van_students',JSON.stringify(arr))}

function renderStudents(){
  const cont = qs('#studentsContainer'); cont.innerHTML='';
  const arr = getStudents();
  if(arr.length===0) cont.innerHTML='<div class="muted">Belum ada siswa.</div>';
  else{
    const tbl = document.createElement('table'); tbl.innerHTML='<thead><tr><th>ID</th><th>Nama</th><th></th></tr></thead>';
    const body = document.createElement('tbody');
    arr.forEach(s=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.id}</td><td>${s.name}</td><td><button data-id="${s.id}" class="btn-ghost deleteStd">Hapus</button></td>`;
      body.appendChild(tr);
    });
    tbl.appendChild(body); cont.appendChild(tbl);
  }
  // student select
  const sel = qs('#studentSelect'); if(sel){sel.innerHTML='';getStudents().forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name;sel.appendChild(o)})}
  renderQRPerStudent();
}

// CSV import (format: id,name)
qs('#csvFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=function(){
    const lines=reader.result.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const arr=getStudents();
    lines.forEach(l=>{const parts=l.split(','); if(parts[0]) arr.push({id:parts[0].trim(),name:(parts[1]||'').trim()})});
    setStudents(arr); renderStudents();
    alert('Import selesai.');
  }; reader.readAsText(f);
});

qs('#addStudent').addEventListener('click',()=>{
  const id=qs('#newId').value.trim(); const name=qs('#newName').value.trim();
  if(!id||!name){alert('Isi id dan nama.');return}
  const arr=getStudents(); if(arr.find(x=>x.id===id)){alert('ID sudah ada.');return}
  arr.push({id,name}); setStudents(arr); renderStudents(); qs('#newId').value=''; qs('#newName').value='';
});

// delete student
document.addEventListener('click',e=>{if(e.target.classList.contains('deleteStd')){const id=e.target.dataset.id;const arr=getStudents().filter(s=>s.id!==id);setStudents(arr);renderStudents();}}
);

// QR per student
function renderQRPerStudent(){
  const wrap=qs('#qrPerStudents'); wrap.innerHTML=''; getStudents().forEach(s=>{
    const el=document.createElement('div'); el.className='card'; el.style.padding='8px'; el.style.width='160px';
    const holder=document.createElement('div'); holder.id='qr_'+s.id; el.appendChild(holder);
    const label=document.createElement('div'); label.className='muted small'; label.textContent=s.name; el.appendChild(label);
    wrap.appendChild(el);
    // generate QR content: format stu:{id}
    new QRCode(holder,{text:`stu:${s.id}`,width:140,height:140});
  })
}

// Session
function startSession(){
  const sid = 'sess_'+Date.now();
  localStorage.setItem('van_session',sid);
  qs('#qrcodeSession').innerHTML=''; new QRCode(qs('#qrcodeSession'),{text:`session:${sid}`,width:220,height:220});
  qs('#sessionInfo').textContent = 'Session aktif: '+sid;
  alert('Sesi absensi dimulai. Tampilkan QR session agar siswa scan atau gunakan QR per siswa.');
}
function endSession(){localStorage.removeItem('van_session');qs('#qrcodeSession').innerHTML='';qs('#sessionInfo').textContent='Tidak ada sesi aktif.'}

qs('#startSession').addEventListener('click',startSession);
qs('#endSession').addEventListener('click',endSession);

// Attendance
function getAttendance(){return JSON.parse(localStorage.getItem('van_attendance')||'[]')}
function setAttendance(a){localStorage.setItem('van_attendance',JSON.stringify(a))}

function markAttendance(id,source='scan'){
  const students=getStudents(); const s=students.find(x=>x.id===id);
  if(!s){console.warn('student not found',id);return false}
  const arr=getAttendance();
  const today = new Date().toISOString().slice(0,10);
  const exists = arr.find(x=>x.id===id && x.date===today);
  if(exists) return false; // already present
  arr.push({id, name:s.name, date:today, time:(new Date()).toLocaleTimeString(), source}); setAttendance(arr); renderAttendance(); return true;
}

function renderAttendance(){
  const tbody=qs('#attendanceTable'); tbody.innerHTML=''; const arr=getAttendance();
  const today=(new Date()).toISOString().slice(0,10);
  const todayRows = arr.filter(a=>a.date===today);
  todayRows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.id}</td><td>${r.name}</td><td>Hadir</td><td>${r.time}</td>`; tbody.appendChild(tr)});
}

qs('#clearAttendance').addEventListener('click',()=>{ if(confirm('Hapus semua absensi hari ini?')){ const all=getAttendance(); const today=(new Date()).toISOString().slice(0,10); const filtered=all.filter(a=>a.date!==today); setAttendance(filtered); renderAttendance(); }});

// Export CSV / PDF
qs('#exportCSV').addEventListener('click',()=>{
  const rows = getAttendance(); if(rows.length===0){alert('Belum ada data.');return}
  let csv = 'ID,Nama,Tanggal,Waktu\n'; rows.forEach(r=>{csv+=`${r.id},"${r.name}",${r.date},${r.time}\n`});
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='absensi.csv'; a.click(); URL.revokeObjectURL(url);
});

qs('#exportPDF').addEventListener('click',async ()=>{
  const rows = getAttendance(); if(rows.length===0){alert('Belum ada data.');return}
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF(); doc.setFontSize(12); doc.text('Laporan Absensi',14,20);
  let y=30; doc.setFontSize(10);
  doc.text('ID | Nama | Tanggal | Waktu',14,y); y+=6;
  rows.forEach(r=>{ if(y>270){doc.addPage(); y=20} doc.text(`${r.id} | ${r.name} | ${r.date} | ${r.time}`,14,y); y+=6});
  doc.save('absensi.pdf');
});

// Export all students
qs('#btnExportAll').addEventListener('click',()=>{
  const arr=getStudents(); if(arr.length===0){alert('Tidak ada siswa.');return}
  let csv='ID,Nama\n'; arr.forEach(s=>csv+=`${s.id},"${s.name}"\n`);
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='siswa.csv'; a.click(); URL.revokeObjectURL(url);
});

// Generate QR per student button (refreshes area)
qs('#generateQRAll').addEventListener('click',renderQRPerStudent);

// Login handling
qs('#loginForm').addEventListener('submit',e=>{e.preventDefault(); const u=qs('#username').value.trim(); const p=qs('#password').value.trim(); if(u===ADMIN_USER && p===ADMIN_PASS){qs('#loginPage').style.display='none';qs('#adminPage').style.display='block'; loadSettings(); renderStudents(); renderAttendance();} else alert('Username atau password salah.');});
qs('#btnLogout').addEventListener('click',()=>{qs('#adminPage').style.display='none';qs('#loginPage').style.display='block';});
qs('#openStudentView').addEventListener('click',()=>{qs('#loginPage').style.display='none';qs('#studentPage').style.display='block'; loadSettings(); renderStudents(); renderStudentHistory();});
qs('#backToLogin').addEventListener('click',()=>{qs('#studentPage').style.display='none';qs('#loginPage').style.display='block';});

// Settings logo
qs('#logoUpload').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{qs('#logoImg').src=r.result;qs('#logoImg').style.display='block'};r.readAsDataURL(f);});
qs('#saveSettings').addEventListener('click',saveSettings);
qs('#resetAll').addEventListener('click',()=>{if(confirm('Hapus semua data di browser?')){localStorage.clear(); location.reload();}});

// Student scanner logic
let video = qs('#video'); let canvas = qs('#canvas'); let ctx = canvas.getContext('2d'); let scanning=false; let videoStream=null;
qs('#scanBtn').addEventListener('click',startScan); qs('#stopScan').addEventListener('click',stopScan);

async function startScan(){ if(scanning) return; try{videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); video.srcObject = videoStream; await video.play(); scanning=true; scanLoop(); }catch(err){alert('Tidak bisa mengakses kamera: '+err.message)} }
function stopScan(){ scanning=false; if(videoStream){videoStream.getTracks().forEach(t=>t.stop()); video.srcObject=null; } }

function scanLoop(){ if(!scanning) return; if(video.readyState===video.HAVE_ENOUGH_DATA){ canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0,canvas.width,canvas.height); const imgData = ctx.getImageData(0,0,canvas.width,canvas.height); const code = jsQR(imgData.data,imgData.width,imgData.height); if(code){ handleQRCode(code.data); stopScan(); } }
 requestAnimationFrame(scanLoop);
}

function handleQRCode(data){
  // formats supported: stu:{id}  OR session:{sid}
  if(data.startsWith('stu:')){
    const id=data.split(':')[1]; const ok=markAttendance(id,'qr-stu'); if(ok) alert('Absensi tercatat untuk ID '+id); else alert('Sudah/ID tidak ditemukan.'); renderStudentHistory();
  } else if(data.startsWith('session:')){
    const sid=data.split(':')[1]; const active = localStorage.getItem('van_session');
    if(active && active===sid){ // ask student to pick name, or auto if student already selected
      const sel=qs('#studentSelect').value; if(!sel){alert('Pilih nama Anda terlebih dahulu agar absensi tercatat.'); return;} const ok=markAttendance(sel,'qr-session'); if(ok) alert('Absensi tercatat untuk '+sel); else alert('Sudah absen.'); renderStudentHistory();
    } else alert('Session tidak valid atau sudah berakhir.');
  } else {
    alert('QR tidak dikenali.');
  }
}

// Student history
function renderStudentHistory(){ const sel=qs('#studentSelect').value; const hist=qs('#studentHistory'); hist.innerHTML=''; const arr=getAttendance().filter(a=>a.id===sel); if(arr.length===0) hist.innerHTML='<div class="muted">Belum ada riwayat.</div>';
  else arr.forEach(r=>{ const d=document.createElement('div'); d.textContent = `${r.date} ${r.time} (${r.source})`; hist.appendChild(d) }); }
qs('#studentSelect').addEventListener('change',renderStudentHistory);

// On load
(function(){ loadSettings(); renderStudents(); renderAttendance(); if(localStorage.getItem('van_session')){qs('#qrcodeSession').innerHTML=''; new QRCode(qs('#qrcodeSession'),{text:'session:'+localStorage.getItem('van_session'),width:220,height:220}); qs('#sessionInfo').textContent='Session aktif: '+localStorage.getItem('van_session'); } else qs('#sessionInfo').textContent='Tidak ada sesi aktif.'; })();

</script>
</body>
</html>
