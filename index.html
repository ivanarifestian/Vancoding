<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Absensi Siswa - VAN KARTU</title>
  <style>
    :root{--tosca:#29b3a7;--blue:#0b76d1}
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial}
    body{margin:0;background:#f6f8fb;color:#222}
    .center{display:flex;align-items:center;justify-content:center}
    /* Login */
    .login-page{height:100vh;background:linear-gradient(135deg,var(--tosca),var(--blue));color:white}
    .login-card{width:360px;background:rgba(255,255,255,0.06);padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.2)}
    .login-card h2{margin:6px 0 16px;font-weight:600}
    .input{width:100%;padding:10px;border-radius:8px;border:0;margin-bottom:10px}
    .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:white;color:var(--blue);font-weight:700}
    .small{font-size:13px;opacity:0.9}

    /* App layout */
    .app{display:flex;height:100vh}
    .sidebar{width:260px;background:white;padding:18px;border-right:1px solid #e6e9ef}
    .main{flex:1;padding:18px;overflow:auto}
    .card{background:white;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
    .h{font-weight:700;margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f0f2f5;text-align:left}
    .flex{display:flex;gap:8px;align-items:center}
    .qr-canvas{width:160px;height:160px}
    .settings img{max-width:100%;height:80px;object-fit:contain}
    .muted{color:#666;font-size:13px}
    .danger{background:#ff605c;color:white}
  </style>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-page center">
  <div class="login-card">
    <div style="text-align:center;margin-bottom:12px">
      <img id="loginLogo" src="" alt="Logo Sekolah" style="height:68px;object-fit:contain;margin-bottom:8px">
      <h2>Admin VAN KARTU</h2>
    </div>
    <div>
      <input id="username" class="input" placeholder="Username" value="Van64">
      <input id="password" type="password" class="input" placeholder="Password" value="Van1909">
      <button id="loginBtn" class="btn btn-primary" style="width:100%">Masuk</button>
      <p class="small" style="margin-top:8px">Gunakan Username: <b>Van64</b> Password: <b>Van1909</b></p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app" style="display:none">
  <div class="sidebar">
    <div style="text-align:center;margin-bottom:12px">
      <img id="sideLogo" src="" alt="Logo" style="height:64px;object-fit:contain">
      <h3 id="schoolName">Nama Sekolah</h3>
      <p class="muted" id="schoolSub">Kepala Sekolah: - | Guru: -</p>
    </div>

    <div class="card">
      <h4 class="h">Menu</h4>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn" onclick="show('students')">Siswa</button>
        <button class="btn" onclick="show('attendance')">Absensi</button>
        <button class="btn" onclick="show('scanner')">Pindai QR</button>
        <button class="btn" onclick="show('settings')">Setelan</button>
        <button class="btn danger" onclick="logout()">Keluar</button>
      </div>
    </div>

    <div class="card">
      <h4 class="h">Unduh</h4>
      <div class="flex" style="flex-direction:column">
        <button class="btn" onclick="exportExcel()">Download Excel</button>
        <button class="btn" onclick="exportPDF()">Download PDF</button>
      </div>
    </div>

  </div>

  <div class="main">
    <!-- STUDENTS -->
    <div id="view-students" class="card" style="display:none">
      <h3 class="h">Daftar Siswa</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="newName" class="input" placeholder="Nama siswa">
        <input id="newId" class="input" placeholder="ID unik (mis. NIS)">
        <button class="btn btn-primary" onclick="addStudent()">Tambah</button>
      </div>
      <div style="margin-bottom:8px">
        <label class="small">Tambah otomatis (CSV):</label>
        <input type="file" id="csvUpload" accept=".csv" onchange="handleCSVUpload(event)">
      </div>
      <table id="studentsTable">
        <thead><tr><th>ID</th><th>Nama</th><th>QR</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ATTENDANCE -->
    <div id="view-attendance" class="card" style="display:none">
      <h3 class="h">Rekap Absensi</h3>
      <div style="margin-bottom:8px">
        <input type="date" id="filterDate" onchange="renderAttendance()"> 
      </div>
      <table id="attendanceTable">
        <thead><tr><th>Waktu</th><th>ID</th><th>Nama</th><th>Status</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SCANNER -->
    <div id="view-scanner" class="card" style="display:none">
      <h3 class="h">Pindai QR (Siswa)</h3>
      <div id="qr-reader" style="width:100%"></div>
      <p class="muted">Catatan: scanner membutuhkan akses kamera. Buka lewat HTTPS atau localhost untuk camera access.</p>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="card settings" style="display:none">
      <h3 class="h">Setelan</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="flex:1">
          <label class="small">Upload Logo Sekolah (akan tersimpan di browser)</label>
          <input type="file" id="logoUpload" accept="image/*" onchange="uploadLogo(event)">
        </div>
        <div style="width:220px;text-align:center">
          <img id="logoPreview" src="" alt="Preview logo" style="height:80px;object-fit:contain">
        </div>
      </div>
      <div style="margin-top:12px">
        <label class="small">Nama Sekolah</label>
        <input id="inpSchoolName" class="input">
        <label class="small">Nama Guru</label>
        <input id="inpTeacher" class="input">
        <label class="small">Nama Kepala Sekolah</label>
        <input id="inpHeadmaster" class="input">
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-primary" onclick="saveSettings()">Simpan</button>
          <button class="btn" onclick="resetData()">Reset Data (bersihkan storage)</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// --- Storage helpers ---
const STORAGE_KEYS = {
  students: 'van_students_v1',
  attendance: 'van_attendance_v1',
  settings: 'van_settings_v1'
}

function load(key, fallback){
  try{ const s = localStorage.getItem(key); return s? JSON.parse(s): fallback }
  catch(e){ return fallback }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }

// default settings
let settings = load(STORAGE_KEYS.settings, {
  schoolName: 'SMA Contoh', teacher: '-', headmaster: '-', logo: ''
})
let students = load(STORAGE_KEYS.students, [])
let attendance = load(STORAGE_KEYS.attendance, [])

// --- Login ---
const ADMIN_USER = 'Van64'
const ADMIN_PASS = 'Van1909'
const loginPage = document.getElementById('loginPage')
const app = document.getElementById('app')

function showLogin(){ loginPage.style.display='flex'; app.style.display='none' }
function showApp(){ loginPage.style.display='none'; app.style.display='flex'; show('students') }

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const u = document.getElementById('username').value.trim()
  const p = document.getElementById('password').value
  if(u===ADMIN_USER && p===ADMIN_PASS){ initApp(); showApp(); }
  else alert('Username atau password salah')
})

function logout(){ if(confirm('Keluar dari admin?')) showLogin() }

// --- UI navigation ---
function show(view){
  document.querySelectorAll('[id^="view-"]').forEach(el=>el.style.display='none')
  document.getElementById('view-'+view).style.display='block'
  if(view==='students') renderStudents()
  if(view==='attendance') renderAttendance()
  if(view==='scanner') startScanner()
  if(view==='settings') renderSettings()
}

// --- Students ---
function addStudent(){
  const name = document.getElementById('newName').value.trim()
  const id = document.getElementById('newId').value.trim()
  if(!name || !id){ alert('Isi nama dan ID'); return }
  if(students.find(s=>s.id===id)){ alert('ID sudah ada'); return }
  students.push({id,name})
  save(STORAGE_KEYS.students, students)
  document.getElementById('newName').value=''
  document.getElementById('newId').value=''
  renderStudents()
}

function removeStudent(id){ if(!confirm('Hapus siswa?')) return; students = students.filter(s=>s.id!==id); save(STORAGE_KEYS.students, students); renderStudents(); }

function renderStudents(){
  const tbody = document.querySelector('#studentsTable tbody')
  tbody.innerHTML=''
  students.forEach(s=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${s.id}</td><td>${s.name}</td><td><div id="qr-${s.id}"></div></td><td><button onclick="removeStudent('${s.id}')">Hapus</button></td>`
    tbody.appendChild(tr)
    // generate QR
    const qrEl = document.getElementById('qr-'+s.id)
    qrEl.innerHTML = ''
    new QRCode(qrEl, {text: s.id, width:120,height:120})
  })
}

// CSV upload: format: id,name
function handleCSVUpload(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader()
  reader.onload = ev=>{
    const text = ev.target.result
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean)
    let added=0
    lines.forEach(line=>{
      const parts = line.split(',')
      if(parts.length>=2){ const id=parts[0].trim(), name=parts.slice(1).join(',').trim(); if(id && name && !students.find(s=>s.id===id)){ students.push({id,name}); added++ } }
    })
    save(STORAGE_KEYS.students, students)
    alert('Ditambahkan '+added+' siswa')
    renderStudents()
  }
  reader.readAsText(f)
}

// --- Attendance ---
function recordAttendance(id, status='Hadir'){
  const s = students.find(x=>x.id===id)
  if(!s){ alert('Siswa tidak ditemukan: '+id); return }
  const now = new Date()
  const rec = {time: now.toISOString(), id: s.id, name: s.name, status}
  attendance.push(rec)
  save(STORAGE_KEYS.attendance, attendance)
  renderAttendance()
}

function renderAttendance(){
  const tbody = document.querySelector('#attendanceTable tbody')
  tbody.innerHTML=''
  const dateFilter = document.getElementById('filterDate').value
  const list = attendance.slice().reverse()
  list.forEach(a=>{
    if(dateFilter){ const d = a.time.slice(0,10); if(d!==dateFilter) return }
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${new Date(a.time).toLocaleString()}</td><td>${a.id}</td><td>${a.name}</td><td>${a.status}</td>`
    tbody.appendChild(tr)
  })
}

// --- Scanner ---
let html5QrScanner = null
function startScanner(){
  const qrReader = document.getElementById('qr-reader')
  qrReader.innerHTML=''
  if(html5QrScanner){ html5QrScanner.clear().catch(()=>{}); html5QrScanner = null }
  html5QrScanner = new Html5Qrcode("qr-reader")
  Html5Qrcode.getCameras().then(devices=>{
    const camId = (devices && devices[0] && devices[0].id) || null
    html5QrScanner.start(camId, {fps:10,qrbox:250}, qrCodeMessage=>{
      // on success
      // by default mark as Hadir; offer option to change
      if(confirm('QR terdeteksi: '+qrCodeMessage+"\nTandai sebagai hadir? (OK=Hadir, Cancel=Ubah)")){
        recordAttendance(qrCodeMessage,'Hadir')
        alert('Absensi hadir tercatat')
      } else {
        const st = prompt('Masukkan keterangan (Hadir / Izin / Sakit)', 'Izin')
        if(st) { recordAttendance(qrCodeMessage, st); alert('Absensi tercatat: '+st) }
      }
    }, errorMessage=>{
      // ignore per-frame errors
    }).catch(err=>{ console.error(err); qrReader.innerHTML = '<p class="muted">Gagal mengaktifkan kamera. Pastikan halaman dibuka via HTTPS atau localhost dan beri izin kamera.</p>' })
  }).catch(err=>{
    qrReader.innerHTML = '<p class="muted">Tidak ada kamera terdeteksi atau akses ditolak.</p>'
  })
}

// --- Settings ---
function uploadLogo(e){
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader(); reader.onload = ev=>{
    settings.logo = ev.target.result; save(STORAGE_KEYS.settings, settings); renderSettings(); applySettings();
  }
  reader.readAsDataURL(f)
}
function renderSettings(){
  document.getElementById('logoPreview').src = settings.logo || ''
  document.getElementById('inpSchoolName').value = settings.schoolName || ''
  document.getElementById('inpTeacher').value = settings.teacher || ''
  document.getElementById('inpHeadmaster').value = settings.headmaster || ''
}
function saveSettings(){
  settings.schoolName = document.getElementById('inpSchoolName').value
  settings.teacher = document.getElementById('inpTeacher').value
  settings.headmaster = document.getElementById('inpHeadmaster').value
  save(STORAGE_KEYS.settings, settings)
  applySettings();
  alert('Disimpan')
}
function applySettings(){
  document.getElementById('schoolName').innerText = settings.schoolName || 'Nama Sekolah'
  document.getElementById('schoolSub').innerText = `Kepala Sekolah: ${settings.headmaster || '-'} | Guru: ${settings.teacher || '-'}`
  document.getElementById('sideLogo').src = settings.logo || ''
  document.getElementById('loginLogo').src = settings.logo || ''
  document.getElementById('logoPreview').src = settings.logo || ''
}

function resetData(){ if(confirm('Reset semua data (siswa, absensi, setelan)?')){ localStorage.clear(); students=[]; attendance=[]; settings={schoolName:'SMA Contoh',teacher:'-',headmaster:'-',logo:''}; save(STORAGE_KEYS.students,students); save(STORAGE_KEYS.attendance,attendance); save(STORAGE_KEYS.settings,settings); renderStudents(); renderAttendance(); renderSettings(); applySettings(); alert('Sudah direset') } }

// --- Export Excel / PDF ---
function exportExcel(){
  // make worksheet from attendance
  const wb = XLSX.utils.book_new()
  const data = attendance.map(a=>({Waktu: a.time, ID: a.id, Nama: a.name, Status: a.status}))
  const ws = XLSX.utils.json_to_sheet(data)
  XLSX.utils.book_append_sheet(wb, ws, 'Absensi')
  XLSX.writeFile(wb, 'absensi.xlsx')
}

async function exportPDF(){
  const { jsPDF } = window.jspdf
  const doc = new jsPDF()
  doc.setFontSize(12)
  doc.text(settings.schoolName || 'Sekolah', 14, 16)
  let y=26
  doc.setFontSize(10)
  doc.text('Rekap Absensi', 14, y); y+=6
  const rows = attendance.slice().reverse().map(a=>[new Date(a.time).toLocaleString(), a.id, a.name, a.status])
  const colWidths = [50,30,60,30]
  // simple table render
  rows.forEach(r=>{
    if(y>280){ doc.addPage(); y=20 }
    doc.text(r[0], 14, y)
    doc.text(r[1], 70, y)
    doc.text(r[2], 100, y)
    doc.text(r[3], 160, y)
    y+=6
  })
  doc.save('absensi.pdf')
}

// --- Init app on successful login ---
function initApp(){ applySettings(); renderStudents(); renderAttendance(); }

// apply if already logged in? we'll always show login first

// expose some functions to window for inline onclick
window.addStudent = addStudent
window.removeStudent = removeStudent
window.handleCSVUpload = handleCSVUpload
window.recordAttendance = recordAttendance
window.exportExcel = exportExcel
window.exportPDF = exportPDF
window.uploadLogo = uploadLogo
window.saveSettings = saveSettings
window.resetData = resetData
window.show = show
window.logout = logout

</script>
</body>
</html>
